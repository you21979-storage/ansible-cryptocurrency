---
- hosts: all
  user: root

  vars:
    tmpdir: /tmp/monacoin
    installdir: /opt/monacoin
  tasks:
    - name: yum install
      yum: name={{item}} state=latest
      with_items:
      - git
      - gcc
      - gcc-c++
      - boost-*
      - zlib-devel
      - zlib-static
      - db4-cxx
      - db4-devel
    - name: temp directory create
      file: dest={{tmpdir}} state=directory
    - name: www download openssl
      get_url: url=http://www.openssl.org/source/openssl-1.0.1f.tar.gz dest={{tmpdir}} mode=0440
    - name: git download miniupnp
      git: repo=https://github.com/miniupnp/miniupnp.git dest={{tmpdir}}/miniupnp
    - name: git download monacoin
      git: repo=https://github.com/monacoinproject/monacoin.git dest={{tmpdir}}/monacoin
    - name: expand openssl
      command: tar zxvf {{tmpdir}}/openssl-1.0.1f.tar.gz chdir={{tmpdir}}
    - name: configure openssl
      command: ./config chdir={{tmpdir}}/openssl-1.0.1f
    - name: make openssl
      command: make chdir={{tmpdir}}/openssl-1.0.1f
    - name: make miniupnpc
      command: make chdir={{tmpdir}}/miniupnp/miniupnpc
    - name: prepare
      file: src={{tmpdir}}/openssl-1.0.1f/include/openssl path={{tmpdir}}/monacoin/src/openssl state=link
    - name: prepare
      file: src={{tmpdir}}/miniupnp/miniupnpc path={{tmpdir}}/monacoin/src/miniupnpc state=link
    - name: prepare
      file: src={{tmpdir}}/miniupnp/miniupnpc/libminiupnpc.a path={{tmpdir}}/monacoin/src/libminiupnpc.a state=link
    - name: make monacoin
      command: make -f makefile.unix BOOST_LIB_SUFFIX=-mt LDFLAGS="-L{{tmpdir}}/openssl-1.0.1f -L." chdir={{tmpdir}}/monacoin/src
    - name: install directory create
      file: dest={{installdir}}/{{item}} state=directory
      with_items:
      - bin
      - etc
      - data
    - name: install monacoind {{installdir}}/bin/monacoind
      file: src={{tmpdir}}/monacoin/src/monacoind dest={{installdir}}/bin/monacoind mode=0755

