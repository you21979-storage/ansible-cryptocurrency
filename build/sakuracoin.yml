---
- hosts: all
  user: root

  vars:
    coinname: sakuracoin
    tmpdir: /tmp/{{coinname}}
    installdir: /opt/{{coinname}}
    gitrepo: https://github.com/ohac/sakuracoin.git
  tasks:
    - name: yum install
      yum: name={{item}} state=latest
      with_items:
      - git
      - gcc
      - gcc-c++
      - boost-*
      - zlib-devel
      - zlib-static
      - db4-cxx
      - db4-devel
    - name: temp directory create
      file: dest={{tmpdir}} state=directory
    - name: git download {{coinname}}
      git: repo={{gitrepo}} dest={{tmpdir}}/{{coinname}}
    - name: www download openssl
      get_url: url=http://www.openssl.org/source/openssl-1.0.1f.tar.gz dest={{tmpdir}} mode=0440
    - name: git download miniupnp
      git: repo=https://github.com/miniupnp/miniupnp.git dest={{tmpdir}}/miniupnp
    - name: expand openssl
      command: tar zxvf {{tmpdir}}/openssl-1.0.1f.tar.gz chdir={{tmpdir}}
    - name: configure openssl
      command: ./config chdir={{tmpdir}}/openssl-1.0.1f
    - name: make openssl
      command: make chdir={{tmpdir}}/openssl-1.0.1f
    - name: make miniupnpc
      command: make chdir={{tmpdir}}/miniupnp/miniupnpc
    - name: prepare
      file: src={{tmpdir}}/openssl-1.0.1f/include/openssl path={{tmpdir}}/{{coinname}}/src/openssl state=link
    - name: prepare
      file: src={{tmpdir}}/miniupnp/miniupnpc path={{tmpdir}}/{{coinname}}/src/miniupnpc state=link
    - name: prepare
      file: src={{tmpdir}}/miniupnp/miniupnpc/libminiupnpc.a path={{tmpdir}}/{{coinname}}/src/libminiupnpc.a state=link
    - name: make {{coinname}}
      command: make -f makefile.unix BOOST_LIB_SUFFIX=-mt LDFLAGS="-L{{tmpdir}}/openssl-1.0.1f -L." chdir={{tmpdir}}/{{coinname}}/src
    - name: install directory create
      file: dest={{installdir}}/{{item}} state=directory
      with_items:
      - bin
      - etc
      - data
    - name: install {{coinname}}d {{installdir}}/bin/{{coinname}}d
      command: cp {{tmpdir}}/{{coinname}}/src/{{coinname}}d {{installdir}}/bin/{{coinname}}d creates={{installdir}}/bin/{{coinname}}d
    - name: init script copy
      template: src=templates/coind/init.j2 dest=/etc/init.d/{{coinname}}d mode=0755

